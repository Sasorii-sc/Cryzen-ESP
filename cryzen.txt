(function() {
    console.log("WebGL Avcısı Başlatıldı...");

    let foundGL = null;

    function searchGL(root) {
        if (foundGL) return;
        
        
        const canvases = root.document.querySelectorAll('canvas');
        canvases.forEach(canvas => {
            const contexts = ['webgl2', 'webgl', 'experimental-webgl'];
            contexts.forEach(ctxName => {
                try {
                    let gl = canvas.getContext(ctxName);
                    if (gl && gl.drawElements) {
                        foundGL = gl;
                        console.log("%c BAŞARILI: WebGL Bağlamı Yakalandı! (" + ctxName + ")", "color: lime; font-weight: bold;");
                    }
                } catch (e) {}
            });
        });

        // Eğer bulunamadıysa iframe'lerin içine bak
        const iframes = root.document.querySelectorAll('iframe');
        iframes.forEach(iframe => {
            try { searchGL(iframe.contentWindow); } catch (e) {}
        });
    }

    searchGL(window);

    if (!foundGL) {
        console.error("HATA: Hiçbir canvas'ta drawElements bulunamadı. Oyun OffscreenCanvas kullanıyor olabilir.");
        return;
    }

    (Hook)
    const originalDrawElements = foundGL.drawElements;
    let autoDetectedCount = 0;
    let stats = {};
    let isAnalyzing = true;

    foundGL.drawElements = function(mode, count, type, offset) {
        if (isAnalyzing) {
            if (count > 2000 && count < 50000) {
                stats[count] = (stats[count] || 0) + 1;
            }
        } else if (count === autoDetectedCount) {
            foundGL.disable(foundGL.DEPTH_TEST);
            originalDrawElements.call(this, mode, count, type, offset);
            foundGL.enable(foundGL.DEPTH_TEST);
            return;
        }
        originalDrawElements.call(this, mode, count, type, offset);
    };

    // 3. Analiz
    setTimeout(() => {
        isAnalyzing = false;
        let maxUsage = 0;
        for (let c in stats) {
            if (stats[c] > maxUsage) {
                maxUsage = stats[c];
                autoDetectedCount = parseInt(c);
            }
        }
        console.log(`%c ANALİZ BİTTİ: Hedeflenen Poligon: ${autoDetectedCount}`, "color: yellow; font-size: 14px;");
    }, 5000);
})();